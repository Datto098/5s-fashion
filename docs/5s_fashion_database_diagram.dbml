// 5S Fashion Database Schema
// File này có thể sử dụng trên https://dbdiagram.io/ để tạo sơ đồ database

Table users {
  id int [pk, increment]
  username varchar(50) [unique]
  email varchar(100) [not null, unique]
  password_hash varchar(255) [not null]
  full_name varchar(100)
  phone varchar(20)
  address varchar(1000)
  avatar varchar(255)
  role enum('admin','customer') [default: 'customer']
  status enum('active','inactive','banned') [default: 'active']
  email_verified_at timestamp
  email_verify_token varchar(100)
  last_login_at timestamp
  remember_token varchar(100)
  reset_token varchar(100)
  reset_token_expires_at timestamp
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
  birthday timestamp [default: 'now()']
  google_id varchar(255)
}

Table brands {
  id int [pk, increment]
  name varchar(100) [not null]
  slug varchar(100) [not null, unique]
  description text
  logo varchar(255)
  website varchar(255)
  status enum('active','inactive') [default: 'active']
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table categories {
  id int [pk, increment]
  name varchar(100) [not null]
  slug varchar(100) [not null, unique]
  description text
  image varchar(255)
  parent_id int
  sort_order int [default: 0]
  status enum('active','inactive') [default: 'active']
  meta_title varchar(255)
  meta_description text
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table products {
  id int [pk, increment]
  name varchar(200) [not null]
  slug varchar(200) [not null, unique]
  description longtext
  short_description text
  sku varchar(50) [unique]
  barcode varchar(50)
  price decimal(10,2) [not null]
  sale_price decimal(10,2)
  cost_price decimal(10,2)
  stock_quantity int [default: 0]
  min_stock_level int [default: 0]
  max_stock_level int
  weight decimal(8,2)
  dimensions varchar(50)
  brand_id int
  status enum('active','inactive','draft','out_of_stock') [default: 'active']
  featured boolean [default: false]
  thumbnail varchar(255)
  gallery json
  seo_title varchar(255)
  seo_description text
  seo_keywords varchar(255)
  views int [default: 0]
  sales_count int [default: 0]
  rating_average decimal(3,2) [default: 0]
  rating_count int [default: 0]
  sort_order int [default: 0]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table product_categories {
  id int [pk, increment]
  product_id int [not null]
  category_id int [not null]
  created_at timestamp [default: 'now()']
}

Table product_attributes {
  id int [pk, increment]
  name varchar(100) [not null]
  slug varchar(100) [not null, unique]
  type enum('color','size','material','style') [not null]
  status enum('active','inactive') [default: 'active']
  sort_order int [default: 0]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table product_attribute_values {
  id int [pk, increment]
  attribute_id int [not null]
  value varchar(100) [not null]
  color_code varchar(7)
  image varchar(255)
  sort_order int [default: 0]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table product_variants {
  id int [pk, increment]
  product_id int [not null]
  sku varchar(50) [unique]
  variant_name varchar(200)
  price decimal(10,2)
  sale_price decimal(10,2)
  cost_price decimal(10,2)
  stock_quantity int [default: 0]
  reserved_quantity int [default: 0]
  weight decimal(8,2)
  dimensions varchar(50)
  image varchar(255)
  gallery json
  status enum('active','inactive','out_of_stock') [default: 'active']
  sort_order int [default: 0]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table product_variant_attributes {
  id int [pk, increment]
  variant_id int [not null]
  attribute_value_id int [not null]
  created_at timestamp [default: 'now()']
}

Table carts {
  id int [pk, increment]
  user_id int
  session_id varchar(255)
  product_id int [not null]
  variant_id int
  quantity int [not null, default: 1]
  price decimal(10,2) [not null]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table orders {
  id int [pk, increment]
  user_id int
  order_code varchar(20) [not null, unique]
  customer_name varchar(100) [not null]
  customer_email varchar(100) [not null]
  customer_phone varchar(20)
  subtotal decimal(10,2) [not null, default: 0]
  tax_amount decimal(10,2) [not null, default: 0]
  shipping_amount decimal(10,2) [not null, default: 0]
  discount_amount decimal(10,2) [not null, default: 0]
  total_amount decimal(10,2) [not null]
  status enum('pending','processing','shipped','delivered','cancelled','refunded') [not null, default: 'pending']
  payment_method enum('cod','bank_transfer','vnpay','momo','zalopay','credit_card') [default: 'cod']
  payment_status enum('pending','paid','failed','refunded') [default: 'pending']
  shipping_address json [not null]
  billing_address json
  notes text
  admin_notes text
  shipped_at timestamp
  delivered_at timestamp
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table order_items {
  id int [pk, increment]
  order_id int [not null]
  product_id int [not null]
  variant_id int
  product_name varchar(200) [not null]
  product_sku varchar(50) [not null]
  variant_info json
  quantity int [not null]
  price decimal(10,2) [not null]
  total decimal(10,2) [not null]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table order_logs {
  id int [pk, increment]
  order_id int [not null]
  status_from varchar(50)
  status_to varchar(50) [not null]
  notes text
  created_by int
  created_at timestamp [default: 'now()']
}

Table customer_addresses {
  id int [pk, increment]
  user_id int [not null]
  name varchar(100) [not null]
  phone varchar(20)
  address varchar(255) [not null]
  is_default boolean [default: false]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
  note text
}

Table coupons {
  id int [pk, increment]
  code varchar(50) [not null, unique]
  name varchar(100) [not null]
  description text
  type enum('percentage','fixed_amount') [not null]
  value decimal(10,2) [not null]
  minimum_amount decimal(10,2)
  maximum_discount decimal(10,2)
  usage_limit int
  used_count int [default: 0]
  user_limit int
  valid_from timestamp
  valid_until timestamp
  status enum('active','inactive','expired') [default: 'active']
  is_featured boolean [default: false]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table user_coupons {
  id int [pk, increment]
  user_id int [not null]
  coupon_id int [not null]
  order_id int
  saved_at timestamp [default: 'now()']
  used_at timestamp
  status enum('saved','used','expired') [default: 'saved']
}

Table coupon_usage {
  id int [pk, increment]
  coupon_id int [not null]
  user_id int
  order_id int [not null]
  discount_amount decimal(10,2) [not null]
  created_at timestamp [default: 'now()']
}

Table reviews {
  id int [pk, increment]
  product_id int [not null]
  user_id int
  order_id int
  rating tinyint [not null]
  title varchar(200)
  content text
  status enum('pending','approved','rejected') [default: 'pending']
  helpful_count int [default: 0]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table review_likes {
  id int [pk, increment]
  review_id int [not null]
  user_id int [not null]
  created_at timestamp [default: 'now()']
}

Table wishlist {
  id int [pk, increment]
  user_id int [not null]
  product_id int [not null]
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table posts {
  id int [pk, increment]
  title varchar(255) [not null]
  content longtext [not null]
  thumbnail varchar(255)
  author_id int [not null]
  created_at datetime [not null]
  updated_at datetime [not null]
  status int [not null]
}

Table settings {
  id int [pk, increment]
  key varchar(100) [not null, unique]
  value longtext
  type enum('string','integer','boolean','json','text') [default: 'string']
  group varchar(50) [default: 'general']
  created_at timestamp [default: 'now()']
  updated_at timestamp [default: 'now()']
}

Table password_reset_tokens {
  id int [pk, increment]
  email varchar(100) [not null]
  token varchar(255) [not null]
  expires_at timestamp [not null]
  created_at timestamp [default: 'now()']
}

// Mối quan hệ (Relationships)

// User relationships
Ref: customer_addresses.user_id > users.id [delete: cascade]
Ref: orders.user_id > users.id [delete: set null]
Ref: carts.user_id > users.id [delete: cascade]
Ref: user_coupons.user_id > users.id [delete: cascade]
Ref: coupon_usage.user_id > users.id [delete: set null]
Ref: reviews.user_id > users.id [delete: set null]
Ref: review_likes.user_id > users.id [delete: cascade]
Ref: wishlist.user_id > users.id [delete: cascade]
Ref: posts.author_id > users.id [delete: cascade]
Ref: order_logs.created_by > users.id [delete: set null]

// Product relationships
Ref: products.brand_id > brands.id [delete: set null]
Ref: product_categories.product_id > products.id [delete: cascade]
Ref: product_categories.category_id > categories.id [delete: cascade]
Ref: product_variants.product_id > products.id [delete: cascade]
Ref: carts.product_id > products.id [delete: cascade]
Ref: carts.variant_id > product_variants.id [delete: cascade]
Ref: order_items.product_id > products.id [delete: cascade]
Ref: order_items.variant_id > product_variants.id [delete: set null]
Ref: reviews.product_id > products.id [delete: cascade]
Ref: wishlist.product_id > products.id [delete: cascade]

// Category relationships
Ref: categories.parent_id > categories.id [delete: set null]

// Product attribute relationships
Ref: product_attribute_values.attribute_id > product_attributes.id [delete: cascade]
Ref: product_variant_attributes.variant_id > product_variants.id [delete: cascade]
Ref: product_variant_attributes.attribute_value_id > product_attribute_values.id [delete: cascade]

// Order relationships
Ref: order_items.order_id > orders.id [delete: cascade]
Ref: order_logs.order_id > orders.id [delete: cascade]
Ref: coupon_usage.order_id > orders.id [delete: cascade]
Ref: user_coupons.order_id > orders.id [delete: set null]
Ref: reviews.order_id > orders.id [delete: set null]

// Coupon relationships
Ref: user_coupons.coupon_id > coupons.id [delete: cascade]
Ref: coupon_usage.coupon_id > coupons.id [delete: cascade]

// Review relationships
Ref: review_likes.review_id > reviews.id [delete: cascade]

// Unique constraints
Ref: user_coupons.user_id - user_coupons.coupon_id [delete: cascade]
Ref: product_variant_attributes.variant_id - product_variant_attributes.attribute_value_id [delete: cascade]
Ref: review_likes.review_id - review_likes.user_id [delete: cascade]
Ref: wishlist.user_id - wishlist.product_id [delete: cascade]
